version: '3.9'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.7.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka1:
    image: confluentinc/cp-kafka:7.7.0
    container_name: kafka1
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://kafka1:19092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1:19092,PLAINTEXT_HOST://localhost:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
    ports:
      - "9092:9092"

  kafka2:
    image: confluentinc/cp-kafka:7.7.0
    container_name: kafka2
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://kafka2:19092,PLAINTEXT_HOST://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2:19092,PLAINTEXT_HOST://localhost:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
    ports:
      - "9093:9093"

  kafka3:
    image: confluentinc/cp-kafka:7.7.0
    container_name: kafka3
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://kafka3:19092,PLAINTEXT_HOST://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3:19092,PLAINTEXT_HOST://localhost:9094
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
    ports:
      - "9094:9094"

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka1:19092,kafka2:19092,kafka3:19092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    depends_on:
      - kafka1
      - kafka2
      - kafka3

  jobmanager:
    build: .
    image: custom-flink:latest
    container_name: jobmanager
    command: jobmanager
    hostname: jobmanager
    ports:
      - "6123:6123"
      - "8081:8081"  
      - "9250:9250"
    volumes:
      - ../flink-app:/opt/flink/app 
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081"]
      interval: 3s
      timeout: 2s
      retries: 10
    depends_on: [kafka1, kafka2, kafka3]

  # Flink TaskManager
  taskmanager:
    build: .
    image: custom-flink:latest
    container_name: taskmanager
    command: taskmanager
    hostname: taskmanager
    environment:
    - JOB_MANAGER_RPC_ADDRESS=jobmanager
    ports:
      - "9251:9250"
    depends_on:
      jobmanager:
        condition: service_healthy
    volumes:
      - ./flink-app:/opt/flink/app


  client:
    build: .
    image: custom-flink:latest
    container_name: client
    depends_on:
      - jobmanager
    entrypoint: ["/bin/bash", "-c"]
    environment:
      - PYTHONPATH=/opt/flink/opt/python/pyflink.zip:/opt/flink/opt/python/py4j-0.10.9.7-src.zip:/opt/flink/opt/python/cloudpickle-2.2.0-src.zip:${PYTHONPATH}
    command: 
      - tail -f /dev/null
    volumes:
      - ./flink-app:/opt/flink/app

  init-topics:
    image: confluentinc/cp-kafka:7.7.0
    container_name: init-topics
    depends_on:
      - kafka1
      - kafka2
      - kafka3
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "
      echo '‚è≥ Waiting for Kafka to be ready...' &&
      cub kafka-ready -b kafka1:19092 1 20 &&
      cub kafka-ready -b kafka2:19092 1 20 &&
      cub kafka-ready -b kafka3:19092 1 20 &&
      echo '‚úÖ Kafka ready. Creating topics...' &&
      kafka-topics --create --if-not-exists --bootstrap-server kafka1:19092 --replication-factor 3 --partitions 3 --topic input-topic &&
      kafka-topics --create --if-not-exists --bootstrap-server kafka1:19092 --replication-factor 3 --partitions 3 --topic output-topic &&
      kafka-topics --create --if-not-exists --bootstrap-server kafka1:19092 --replication-factor 3 --partitions 3 --topic events &&
      echo 'üéâ Topics created successfully!' &&
      sleep 2
      "

  prometheus:
    image: prom/prometheus:v3.7.0
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:12.4.0-19344475766
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    volumes:
      - ./grafana/provisioning/:/etc/grafana/provisioning/
      - ./grafana/dashboards/:/var/lib/grafana/dashboards
